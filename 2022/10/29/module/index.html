<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> nn.Module を読んでみた · gojiteji's Blog</title><meta name="description" content="nn.Module を読んでみた - gojiteji"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.gojtieji.com/atom.xml" title="gojiteji's Blog"><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="gojiteji's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://gojiteji.com" target="_blank" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">nn.Module を読んでみた</h1><div class="tags"><a href="/tags/ML/" class="tag-title">#ML</a></div><div class="post-info">2022年10月29日</div><div class="post-content"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">この資料はラボ内自主勉強会に向けて書いたものです。間違い等ありましたら教えてください。</span><br></pre></td></tr></table></figure>

<h3 id="nn-Moduleとは？"><a href="#nn-Moduleとは？" class="headerlink" title="nn.Moduleとは？"></a>nn.Moduleとは？</h3><p>PyTorchでカスタムモデルを作成する際にクラスで継承するやつ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleModel</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.fc1 = nn.Linear(<span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">        self.act = nn.sigmoid()</span><br><span class="line">        self.fc2 = nn.Linear(<span class="number">100</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        y = self.fc1(x)</span><br><span class="line">        y = self.act(y)</span><br><span class="line">        y = self.fc2(y)</span><br><span class="line">        <span class="keyword">return</span> y</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h3 id="【事前知識】pythonの外部ファイルのクラスを実行可能にする方法"><a href="#【事前知識】pythonの外部ファイルのクラスを実行可能にする方法" class="headerlink" title="【事前知識】pythonの外部ファイルのクラスを実行可能にする方法"></a>【事前知識】pythonの外部ファイルのクラスを実行可能にする方法</h3><p>カレントディレクトリのhogeファイルのfugaクラスを読み込む場合</p>
<h5 id="main-py"><a href="#main-py" class="headerlink" title="main.py"></a><code>main.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .hoge <span class="keyword">import</span> fuga </span><br></pre></td></tr></table></figure>
<p>カレントディレクトリのhogeファイルの全てのクラスを読み込む場合</p>
<h5 id="main-py-1"><a href="#main-py-1" class="headerlink" title="main.py"></a><code>main.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .hoge <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<p>カレントディレクトリのhoge<strong>ディレクトリ</strong>のFuga1,Fuga2クラスを読み込む場合</p>
<h5 id="main-py-2"><a href="#main-py-2" class="headerlink" title="main.py"></a><code>main.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .hoge <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<h5 id="hoge-init-py"><a href="#hoge-init-py" class="headerlink" title="/hoge/__init__.py"></a><code>/hoge/__init__.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> *</span><br><span class="line">__all__=[<span class="string">&quot;Fuga&quot;</span>,<span class="string">&quot;Fuga2&quot;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="hoge-fuga-py"><a href="#hoge-fuga-py" class="headerlink" title="/hoge/fuga.py"></a><code>/hoge/fuga.py</code></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Fuga</span><br><span class="line"></span><br><span class="line">class Fuga2</span><br></pre></td></tr></table></figure>



<h2 id="どこに継承元のModuleクラスが書いてある？"><a href="#どこに継承元のModuleクラスが書いてある？" class="headerlink" title="どこに継承元のModuleクラスが書いてある？"></a>どこに継承元のModuleクラスが書いてある？</h2><p>外部ファイルが存在?<br>→<code>torch/nn/Module.py</code>は存在しない</p>
<p>書き方的に、<code>torch/nn</code>ディレクトリに存在<br>Pythonは外部ディレクトリを読み込み時に<code>__init__.py</code>を先に読む。<br>nn.Module→<code>nn</code>ディレクトリの<code>__init__.py</code>を読む<br>👉<a target="_blank" rel="noopener" href="https://github.com/pytorch/pytorch/blob/master/torch/nn/__init__.py">source</a></p>
<p>しかし、ここにも書いていない</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .modules <span class="keyword">import</span> *  <span class="comment"># noqa: F403</span></span><br></pre></td></tr></table></figure>
<p>つまり、<code>nn/module/</code>を全て読み込んでいる。<br>→<code>nn/module/__init__.py</code>を見る<br>👉<a target="_blank" rel="noopener" href="https://github.com/pytorch/pytorch/blob/master/torch/nn/modules/__init__.py">source</a></p>
<p>Moduleクラスを読み込んでいる部分を発見!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .module <span class="keyword">import</span> Module</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">__all__ = [</span><br><span class="line">    <span class="string">&#x27;Module&#x27;</span>, <span class="string">&#x27;Identity&#x27;</span>, <span class="string">&#x27;Linear&#x27;</span>, <span class="string">&#x27;Conv1d&#x27;</span>, <span class="string">&#x27;Conv2d&#x27;</span>, <span class="string">&#x27;Conv3d&#x27;</span>, <span class="string">&#x27;ConvTranspose1d&#x27;</span>,</span><br></pre></td></tr></table></figure>

<p><code>nn/module/module.py</code>にModuleクラスが存在しているはず。</p>
<p>👉<a target="_blank" rel="noopener" href="https://github.com/pytorch/pytorch/blob/master/torch/nn/modules/module.py">nn&#x2F;module.py</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Module</span>:</span><br><span class="line">    <span class="string">r&quot;&quot;&quot;Base class for all neural network modules.   </span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">.</span></span><br></pre></td></tr></table></figure>

<h2 id="インスタンス生成時に実行されるもの"><a href="#インスタンス生成時に実行されるもの" class="headerlink" title="インスタンス生成時に実行されるもの"></a>インスタンス生成時に実行されるもの</h2><p>インスタンス生成例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model=SimpleModel()</span><br></pre></td></tr></table></figure>
<p>👉<a target="_blank" rel="noopener" href="https://github.com/pytorch/pytorch/blob/e3e84830aade59722d819bc5fa01922239494790/torch/nn/modules/module.py#L425">source</a></p>
<h4 id="setattr"><a href="#setattr" class="headerlink" title="__setattr__"></a><code>__setattr__</code></h4><p><code>__setattr__</code>: インスタンスで代入操作実行時に呼び出されるコンストラクタ</p>
<p><code>(代入された変数,代入された値)</code><br>→ex.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">super</span>().__setattr__(<span class="string">&#x27;_parameters&#x27;</span>, OrderedDict())</span><br></pre></td></tr></table></figure>
<p>→<code>_parameters</code>に代入された時、辞書順にソートする。</p>
<h4 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a><code>Callable</code></h4><ul>
<li><p><code>Callable</code> 関数の型のようなもの。</p>
</li>
<li><p><code>関数名 Callable([引数型], 返り値型)</code><br> <code>...</code>→Ellipsisという、Noneだけど、bool(…)でTrueを返すオブジェクト。今は無いけど、そのうちあることを示唆するような感じ。<br>つまり、<code>forward: Callable[..., Any]</code>→…はforwardの引数の型、Anyがforwardの出力の型</p>
</li>
<li><p><code>_forward_unimplemented</code>はそのまま呼び出すと<code>NotImplementedError</code>を吐く関数。<br>→forward関数を、何か実装する雛形として宣言する。</p>
</li>
</ul>
<p>つまりこのセクションで言いたいのは・・・<br><strong>Moduleクラスの継承はインスタンス作成時にforwardを絶対に実装する必要がある！</strong></p>
<h2 id="インスタンス呼び出し時に実行されるもの"><a href="#インスタンス呼び出し時に実行されるもの" class="headerlink" title="インスタンス呼び出し時に実行されるもの"></a>インスタンス呼び出し時に実行されるもの</h2><p><code>def __call__</code>はどこに？</p>
<p>これも同様に、Callableで宣言はして、<code>_call_impl</code>で置き換えている。<br><code> __call__ : Callable[..., Any] = _call_impl</code></p>
<p><code>_call_impl</code>は何をしている？</p>
<p><code>*hook</code>系のものは、そのhookがTrueの時実行するもの。(ex.forward pass, backward passで__call__の処理を変える。)<br>→一旦<code>self.forward</code>が実行されていると考えていい。<br>nn.Module継承先から呼び出す場合、継承先の<code>self.forward</code>が実行される。</p>
<p>つまりこのセクションで言いたいのは・・・<br><strong>クラスや型の機能を使ってfoward&#x2F;backwardで処理を変更可能なモデル実行の雛形を作っている。</strong></p>
</div></article></div></main><footer><div class="paginator"><a href="/2022/11/18/huggingface-how-padding-works/" class="prev">上一篇</a><a href="/2022/08/12/OSScommit/" class="next">下一篇</a></div><div class="copyright"><p>© undefined - 2022 <a href="https://blog.gojtieji.com">gojiteji</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>